<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KinetiQuest - Welcome</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root {
            --pixel-size: 6;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(45deg, #ff9a9e, #fad0c4, #ff9a9e);
            background-size: 300% 300%;
            animation: gradientAnimation 10s ease infinite;
            overflow: hidden;
        }
        .container {
            text-align: center;
            font-size: 6em;
        }
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
    <style>
        .profile-button {
            position: fixed;
            top: 3%;
            right: 7%;
            background-color: #a37b5b;
            color: #fff;
            padding: 0.5em 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: Arial, sans-serif;
            font-size: 1.2em;
            z-index: 900;
        }
        .profile-button:hover {
            background-color: #a37b5b;
        }

        .logout-button {
            position: fixed;
            top: 3%;
            right: 1%;
            background-color: #a37b5b;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: Arial, sans-serif;
            font-size: 1.2em;
            z-index: 900;
        }

        .logout-button:hover {
            background-color: #a37b5b;
        }

        .completed-tasks-button {
            position: fixed;
            top: 3%;
            right: 13%;
            background-color: #a37b5b;
            color: #fff;
            padding: 0.5em 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: Arial, sans-serif;
            font-size: 1.2em;
            z-index: 900;
        }

        .completed-tasks-button:hover {
            background-color: #a37b5b;
        }

        .close-button {
            background-color: #d6bfa3;
            color: #fff;
            padding: 0.5em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
        }

        .close-button:hover {
            background-color: #0056b3;
        }

        .green-text {
            color: green;
        }
    </style>
    <style>
        .profile-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2em;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: none;
            z-index: 999;
        }
        .profile-popup h3 {
            margin: 0 0 15px;
            font-size: 1.5em;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }

        .logout-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2em;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: none;
            z-index: 1000;
        }
        .logout-popup h3 {
            margin: 0 0 15px;
            font-size: 1.5em;
        }

        .logout-popup button {
            background-color: #d6bfa3;
            color: #fff;
            padding: 0.5em 1em;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 0 10px;
        }
        .logout-popup button:hover {
            background-color: #0056b3;
        }
        .logout-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }

        .completed-tasks-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2em;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: none;
            z-index: 1000;
        }

        .completed-tasks-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }

        .completed-tasks-popup h3 {
            margin: 0 0 15px;
            font-size: 1.5em;
        }

        .completed-task {
            text-decoration: line-through;
            opacity: 0.6;
        }

         .happiness-area {
            width: 29em;
            height: 9.5em;
            padding: 1em;
            background-color: #d6bfa3;
            border-radius: 10px;
            margin-top: 0.5em;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            align-self: flex-start;
            margin-left: -10em;
        }

        .happiness-bar, .hunger-bar {
            margin: 0.5em 0;
            font-size: 1em;
        }

        progress {
            width: 100%;
            height: 1.5em;
        }
    </style>
    <!-- Header and Top Margin Code -->
    <style>
        .line {
            position: fixed;
            top: 10.5%;
            left: 0;
            height: 6px;
            width: 100%;
            background-color: #000;
            z-index: 1;
        }

        .container img {
            position: fixed;
            top: 1%;
            left: 1%;
            width: 5%;
            height: auto;
            z-index: 900;
        }

        .content-wrapper {
            margin-top: 7em;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            gap: 4em;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: -5em;
        }

        .pet-area {
            background-color: #d6bfa3;
            padding: 0.5em;
            border-radius: 1em;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            width: 30em;
            height: 30em;
            position: relative;
            margin-left: -10em;
        }

        .todo-lists {
            display: flex;
            flex-direction: column;
            width: 150%;
        }

        .todo-list {
            max-height: 300px;
            overflow-y: auto;
            background-color: #d6bfa3;
            padding: 2em;
            border-radius: 1em;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            width: 170%;
            position: relative;
            margin-top: 1em;
        }

        .scrollable-tasks {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            display: block;
            flex-wrap: wrap;
            height: 300px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1em;
        }

        .scrollable-tasks::-webkit-scrollbar {
            width: 12px;
        }

        .scrollable-tasks::-webkit-scrollbar-track {
            background: #f1e1c7;
            border-radius: 10px;
        }

        .scrollable-tasks::-webkit-scrollbar-thumb {
            background: #a37b5b;
            border-radius: 10px;
        }

        .scrollable-tasks::-webkit-scrollbar-thumb:hover {
            background: #8a634b;
        }

        .pet-display {
            background: url('/static/BackgroundPet.png') no-repeat center center;
            background-size: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 30em;
            height: 30em;
            position: relative;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
        }

        .food-area {
            width: 29em;
            padding: 1em;
            background-color: #d6bfa3;
            border-radius: 10px;
            display: flex;
            justify-content: space-evenly;
            align-items: flex-start;
            gap: 1em;
            margin-top: 1em;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            margin-left: -10em;
        }

        .food-item-container {
            display: flex;
            width: 35em;
            flex-direction: column;
            align-items: center;
        }

        .food-item {
            width: 20%;
            max-width: 4em;
            height: 4em;
            background-image: url('../static/food.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: grab;
            margin-bottom: -0.5em;
        }

        .food-label {
            margin-top: 0.5em;
            font-size: 0.9em;
            color: #333;
            text-align: center;
        }

        .food-drop-zone {
            width: 15%;
            max-width: 5em;
            height: 4em;
            border: 0.2em dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .todo-list h2, {
            text-align: center;
            font-size: 2.5em;
            margin-top: 0.5em;

        }

        .tasks {
            margin-top: 1em;
        }

        .task {
            display: flex;
            flex-grow: 1;
            align-items: center;
            max-width: calc(100% - 2em);
            overflow-wrap: break-word;
            word-break: break-word;
            text-overflow: ellipsis;
            overflow: hidden;
            padding: 0.5em;
            outline: none;
            border: none;
            background: none;
            cursor: text;
        }

        .styled-checkbox {
            appearance: none;
            width: 1.5em;
            height: 1.5em;
            border: 2px solid #4CAF50;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            margin-right: 10px;
        }

        .styled-checkbox:checked {
            background-color: #4CAF50;
            border: none;
        }

        .styled-checkbox:checked::before {
            content: 'âœ“';
            color: white;
            font-size: 1.2em;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .task:hover {
            background-color: #c9a98c;
        }

        .task .complete-checkbox {
            visibility: hidden;
            margin-right: 10px;
        }

        .task:hover .complete-checkbox {
            visibility: visible;
        }

        .task-content {
            flex-grow: 1;
        }

        .task:focus {
            max-height: 2em;
            overflow-y: auto;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        .task input[type="checkbox"] {
            margin-right: 1em;
        }

        .input-task {
            margin-top: 1em;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .input-task button {
            padding: 0.5em 1em;
            font-size: 1.2em;
            background-color: #a37b5b;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            transition: background-color 0.3s ease;
            z-index: 2;
        }

        .input-task button:hover {
            background-color: #0056b3;
        }

        .task-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2em;
            border-radius: 1em;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: none;
            z-index: 999;
        }

        .task-popup input[type="text"] {
            width: 80%;
            padding: 0.5em;
            font-size: 1.2em;
            border-radius: 5em;
            border: 0.1em solid #ccc;
            margin-bottom: 1em;
            box-sizing: border-box;
            z-index: 999;
        }

        .task-popup button {
            padding: 0.5em 1em;
            font-size: 1.2em;
            background-color: #d6bfa3;
            color: #fff;
            border: none;
            border-radius: 2em;
            cursor: pointer;
            margin: 0.5em;
            z-index: 999;
        }

        .task-popup button:hover {
            background-color: #0056b3;
        }

        .task-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }

        .delete-button {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0.2em 0.6em;
            font-size: 1em;
            line-height: 1em;
            display: none;
            z-index: 1;
            transition: background-color 0.3s;
        }

        .task-wrapper {
            margin: 0;
            padding: 0em;
            box-sizing: border-box;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 8px;
        }

        .task-wrapper:hover .delete-btn {
            display: block;
        }

        .delete-btn {
            position: absolute;
            right: 10px;
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0.2em 0.6em;
            font-size: 1em;
            display: none;
            transition: background-color 0.3s;
        }

        .delete-btn:hover {
            background-color: #c9302c;
        }

        .dimmed {
            filter: brightness(90%);
            pointer-events: none;
        }

        #pet {
            width: calc(32px * var(--pixel-size));
            height: calc(32px * var(--pixel-size));
            position: absolute;
            left: 0;
            top: 0;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
        }

    </style>
</head>
<body>
<!-- Header and Top Margin Code -->
<div class="header" style="text-align: center; width: 75%; position: fixed; top: 0px; z-index: 900;">
    <h1 style="font-family: 'VT323', monospace; font-size: 5em; margin: 10px 10px;">KinetiQuest</h1>
</div>
<div class="line"></div>
<div class="container">
    <img id="logo" src="../static/dogandcat.png" alt="Dog and Cat" draggable="true" ondragstart="drag(event)">
</div>

<!-- Completed Quests -->
<button class="completed-tasks-button" onclick="showCompletedTasks()">Completed Quests</button>
<button class="profile-button" onclick="showProfile()">Profile</button>
<button class="logout-button" onclick="showLogout()">Logout</button>

<!-- Main Content Area Wrapper -->
<div class="content-wrapper">
    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Pet Area -->
        <div class="pet-area" ondrop="drop(event)" ondragover="allowDrop(event)">
            <div class="pet-display">
                <img id="pet" src="/static/Pet_Animations/{{ pet_type }}/{{ pet_type }}_Idle.gif" alt="{{ pet_name }}">
            </div>
        </div>

        <!-- Happiness Area -->
        <div class="happiness-area">
            <h2 style="text-align: center;">{{ pet_name }} Happiness & Hunger Levels</h2>
            <div class="happiness-bar">
                <label for="happiness">Happiness:</label>
                <progress id="happiness" value="{{ pet_happiness }}" max="100"></progress>
            </div>
            <div class="hunger-bar">
                <label for="hunger">Hunger:</label>
                <progress id="hunger" value="{{ pet_hunger }}" max="100"></progress>
            </div>
        </div>

        <!-- Food Area -->
        <div class="food-area">
            <div class="food-item-container">
                <div id="foodIMG" class="food-item" draggable="true" ondragstart="drag(event)" style="background-image: url('../static/food.png');"></div>
                <span class="food-label">Food Quantity: <span id="foodQuantity"></span></span>
            </div>
            <div class="food-item-container">
                <div id="specialfoodIMG" class="food-item" draggable="true" ondragstart="drag(event)" style="background-image: url('../static/specialfood.png');"></div>
                <span class="food-label">Special Food Quantity: <span id="specialfoodQuantity"></span></span>
            </div>
        </div>
    </div>

    <!-- To-do Lists Area -->
    <div class="todo-lists">
        <!-- Daily To-do List Area -->
        <div class="todo-list">
            <div class="input-task" style="position: absolute; top: 20px; right: 40px;">
                <button onclick="showTaskPopup('daily')">Add Quest</button>
            </div>

            <h2 style="text-align: left; margin-bottom: 10px;">Quests</h2>
            <hr style="border: 1px solid #d6b588;">

            <!-- Scrollable task list -->
            <div class="scrollable-tasks" id="dailyTasks">
                {% for quest in user_quests %}
                {% if quest.quest_type == 'daily' %}
                <div class="task-wrapper">
                    <div class="task {% if quest.status == 'completed' %}completed-task{% endif %}" data-task-id="{{ quest.id }}">
                        <input type="checkbox" class="complete-checkbox styled-checkbox" onclick="markTaskComplete('{{ quest.id }}', 'daily')"
                               {% if quest.status == 'completed' %}checked disabled{% endif %}>
                        <span class="task-text" contenteditable="true">{{ quest.description }}</span>
                        <button class="delete-btn" onclick="deleteTask('{{ quest.id }}')">&times;</button>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Task Popup -->
<div class="task-popup" id="taskPopup" style="display: none; flex-direction: column; gap: 1em; width: 400px;">
    <h3>Add New Task</h3>
    <div style="display: flex; flex-direction: column; gap: 0.5em;">
        <input type="text" id="taskInput" placeholder="Enter a new task" maxlength="29" style="width: 100%;">
        <label for="dueDateInput">Due Date:</label>
        <input type="date" id="dueDateInput" placeholder="Due Date">
    </div>

    <!-- Time Selection UI -->
    <div class="time-selection" style="display: flex; flex-direction: column; gap: 1em; margin-top: 1em;">
        <label for="dueTimeInput">Time:</label>
        <div style="display: flex; flex-direction: row;">
            <input type="radio" id="endOfDay" name="dueTime" value="23:59">
            <label for="endOfDay">End of Day (11:59 PM)</label>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5em;">
            <input type="radio" id="specificTime" name="dueTime" value="specific">
            <label for="specificTime">Specific Time:</label>
            <input type="time" id="dueTimeInput" placeholder="Due Time" disabled>
        </div>
    </div>

    <!-- Repeat option selection for the task -->
    <div class="repeat-option-container" style="display: flex; flex-direction: column; margin-top: 1em;">
        <label for="repeatOption">Repeat:</label>
        <select id="repeatOption" onchange="toggleRepeatDays()">
            <option value="none">Do not repeat</option>
            <option value="daily">Daily Repetition</option>
            <option value="weekly">Weekly Repetition</option>
            <option value="specific">Select Days</option>
        </select>
    </div>

    <div id="repeatDaysInputContainer" style="display:none; flex-direction: column; gap: 0.5em;">
        <label>Select Days:</label>
        <div>
            <input type="checkbox" id="monday" value="Monday">
            <label for="Monday">Monday</label>
        </div>
        <div>
            <input type="checkbox" id="tuesday" value="Tuesday">
            <label for="Tuesday">Tuesday</label>
        </div>
        <div>
            <input type="checkbox" id="wednesday" value="Wednesday">
            <label for="Wednesday">Wednesday</label>
        </div>
        <div>
            <input type="checkbox" id="thursday" value="Thursday">
            <label for="Thursday">Thursday</label>
        </div>
        <div>
            <input type="checkbox" id="friday" value="Friday">
            <label for="Friday">Friday</label>
        </div>
        <div>
            <input type="checkbox" id="saturday" value="Saturday">
            <label for="Saturday">Saturday</label>
        </div>
        <div>
            <input type="checkbox" id="sunday" value="Sunday">
            <label for="Sunday">Sunday</label>
        </div>
    </div>

    <div style="display: flex; gap: 1em; justify-content: center;">
        <button onclick="addTask()">Add</button>
        <button onclick="closeTaskPopup()">Cancel</button>
    </div>
</div>

<!-- Profile Popup -->
<div class="popup-overlay" id="popupOverlay"></div>
<div class="profile-popup" id="profilePopup">
    <h3>Profile</h3>
    <p>Username: {{ session['username'] }}</p>
    <button class="close-button" onclick="closeProfilePopup()">Close</button>
</div>

<!-- Logout Popup -->
<div class="logout-overlay" id="logoutOverlay"></div>
<div class="logout-popup" id="logoutPopup">
    <h3>Logout</h3>
    <p>Are you sure you want to logout?</p>
    <button onclick="logoutProfile()">Yes</button>
    <button onclick="closeLogoutPopup()">No</button>
</div>
<button class="logout-button" onclick="showLogout()">Logout</button>

<!-- Completed Quests Popup -->
<div class="completed-tasks-overlay" id="completedTasksOverlay"></div>
<div class="completed-tasks-popup" id="completedTasksPopup">
    <div id="dailyCompletedTasks">
        <h4>Completed Quests</h4>
        <div id="dailyTasksList"></div>
    </div>
    <button class="close-button" onclick="closeCompletedTasks()">Close</button>
</div>

<!-- JavaScript Code -->
<script>
    let currentTaskType = '';
    let foodQuantity = 1;
    let specialfoodQuantity = 1;

    function togglePopup(popupId, show) {
        const popupElement = document.getElementById(popupId);
        const overlayElement = document.getElementById('popupOverlay');
        popupElement.style.display = show ? 'block' : 'none';
        overlayElement.style.display = show ? 'block' : 'none';
        if (show) {
            overlayElement.style.pointerEvents = 'auto';
        } else {
            overlayElement.style.pointerEvents = 'none';
        }
    }

    function showProfile() {
        togglePopup('profilePopup', true);
    }

    function closeProfilePopup() {
        togglePopup('profilePopup', false);
    }

    function showLogout() {
        togglePopup('logoutPopup', true);
    }

    function closeLogoutPopup() {
        togglePopup('logoutPopup', false);
    }

    function logoutProfile() {
        togglePopup('logoutPopup', false);
        window.location.href = '/';
    }

    function closeCompletedTasks() {
        togglePopup('completedTasksPopup', false);
        document.getElementById('completedTasksOverlay').style.display = 'none';
    }

    function closeTaskPopup() {
        document.getElementById('taskPopup').style.display = 'none';
        document.getElementById('taskOverlay').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Fetch the initial food quantities from the server
        fetch('/api/get_food_quantities')
            .then(response => response.json())
            .then(data => {
                if (data.food_quantity !== undefined && data.special_food_quantity !== undefined) {
                    foodQuantity = data.food_quantity;
                    specialfoodQuantity = data.special_food_quantity;
                    updateFoodQuantity(); // Update the displayed quantities
                } else {
                    console.error('Failed to fetch food quantities');
                }
            })
            .catch(error => {
                console.error('Error fetching food quantities:', error);
            });
    });

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.task-text').forEach(taskElement => {
            taskElement.addEventListener('focus', function() {
                this.dataset.originalValue = this.innerText;
            });
            taskElement.addEventListener('blur', function() {
                const taskId = this.closest('.task').dataset.taskId;
                const newDescription = this.innerText;
                updateTask(taskId, newDescription);
            });
            taskElement.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    this.innerText = this.dataset.originalValue;
                    this.blur();
                } else if (event.key === 'Enter') {
                    event.preventDefault();
                    this.blur();
                }
            });
            taskElement.addEventListener('input', function() {
                if (this.innerText.length > 29) {
                    this.innerText = this.innerText.substring(0, 29);
                    const range = document.createRange();
                    const selection = window.getSelection();
                    range.selectNodeContents(this);
                    range.collapse(false);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            });
        });
    });

    function dimContent(dim) {
        const dimClass = 'dimmed';
        const elementsToDim = document.querySelectorAll('body > *:not(#popupOverlay):not(#profilePopup):not(#logoutPopup)');
        elementsToDim.forEach(element => {
            if (dim) {
                element.classList.add(dimClass);
            } else {
                element.classList.remove(dimClass);
            }
        });
    }

    document.getElementById('specificTime').addEventListener('change', function() {
        document.getElementById('dueTimeInput').disabled = !this.checked;
    });
    document.getElementById('endOfDay').addEventListener('change', function() {
        document.getElementById('dueTimeInput').disabled = true;
    });

    function toggleRepeatDays() {
        const repeatOption = document.getElementById('repeatOption').value;
        const repeatDaysContainer = document.getElementById('repeatDaysInputContainer');
        repeatDaysContainer.style.display = (repeatOption === 'specific') ? 'flex' : 'none';
    }

    function getSelectedRepeatDays() {
        const days = [];
        document.querySelectorAll('#repeatDaysInputContainer input[type="checkbox"]:checked').forEach(checkbox => 
        { days.push(checkbox.value); });
        return days;
    }

    function addTask() {
        const taskInputElement = document.getElementById('taskInput');
        const taskInput = taskInputElement.value;
        const dueDate = document.getElementById('dueDateInput').value;
        const dueTime = document.querySelector('input[name="dueTime"]:checked').value === "specific"
            ? document.getElementById('dueTimeInput').value
            : "23:59";
        const repeatOption = document.getElementById('repeatOption').value;
        const repeatDays = repeatOption === "specific" ? getSelectedRepeatDays() : [];

        if (taskInput.length > 29) {
            alert("Task description cannot exceed 29 characters.");
            return;
        }

        if (!taskInput.trim()) {
            alert("Task description cannot be empty.");
            return;
        }

        const formData = new URLSearchParams();
        formData.append('task_description', taskInput);
        formData.append('due_date', dueDate);
        formData.append('due_time', dueTime);
        formData.append('task_type', repeatOption);
        repeatDays.forEach(day => formData.append('repeat_days', day));

        fetch('/api/add_task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const taskList = document.getElementById(currentTaskType === 'daily' ? 'dailyTasks' : 'weeklyTasks');
                const newTaskWrapper = document.createElement('div');
                newTaskWrapper.classList.add('task-wrapper');

                const taskContainer = createTaskContainer(taskInput, data.task_id);
                newTaskWrapper.appendChild(taskContainer);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-btn');
                deleteButton.innerHTML = '&times;';
                deleteButton.onclick = () => deleteTask(data.task_id);
                newTaskWrapper.appendChild(deleteButton);

                taskList.appendChild(newTaskWrapper);
                taskInputElement.value = '';
            } else {
                alert('Failed to add task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error occurred while making the request:', error);
            alert('An error occurred while adding the task.');
        });
        closeTaskPopup();
    }

    function createTaskContainer(taskInput, taskId) {
        const taskContainer = document.createElement('div');
        taskContainer.classList.add('task');
        taskContainer.dataset.taskId = taskId;

        const completeCheckbox = document.createElement('input');
        completeCheckbox.type = 'checkbox';
        completeCheckbox.classList.add('complete-checkbox', 'styled-checkbox');
        completeCheckbox.onclick = () => markTaskComplete(taskId);
        taskContainer.appendChild(completeCheckbox);

        const taskText = document.createElement('span');
        taskText.classList.add('task-text');
        taskText.contentEditable = 'true';
        taskText.textContent = taskInput;
        addTaskTextEventListeners(taskText);
        taskContainer.appendChild(taskText);

        return taskContainer;
    }

    function addTaskTextEventListeners(taskText) {
        taskText.addEventListener('focus', function() {
            this.dataset.originalValue = this.innerText;
        });
        taskText.addEventListener('blur', function() {
            const taskId = this.closest('.task').dataset.taskId;
            const newDescription = this.innerText;
            updateTask(taskId, newDescription);
        });
        taskText.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                this.innerText = this.dataset.originalValue;
                this.blur();
            } else if (event.key === 'Enter') {
                event.preventDefault();
                this.blur();
            }
        });
    }

    function updateTask(taskId, newDescription) {
        if (!newDescription.trim()) {
            alert("Task description cannot be empty.");
            return;
        }
        fetch('/api/update_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `task_id=${encodeURIComponent(taskId)}&new_description=${encodeURIComponent(newDescription)}`
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                alert('Failed to update task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the task.');
        });
    }

    function adjustScrollableHeight() {
        const scrollableTasks = document.querySelector('.scrollable-tasks');
        const taskCount = scrollableTasks.children.length;

        if (taskCount === 0) {
            scrollableTasks.style.height = 'auto';
        } else {
            scrollableTasks.style.height = '';
        }
    }

    function deleteTask(taskId) {
        fetch('/api/delete_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `task_id=${encodeURIComponent(taskId)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the task from the list in the frontend
                const taskElement = document.querySelector(`.task[data-task-id='${taskId}']`).closest('.task-wrapper');
                if (taskElement) {
                    taskElement.remove();
                }
            } else {
                alert('Failed to delete task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the task.');
        });
    }

    function markTaskComplete(taskId) {
        fetch(`/api/complete_task`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `task_id=${encodeURIComponent(taskId)}`
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                const taskWrapper = document.querySelector(`.task[data-task-id='${taskId}']`).closest('.task-wrapper');
                if (taskWrapper) {
                    taskWrapper.querySelector('.task').classList.add('completed-task');
                    taskWrapper.querySelector('.complete-checkbox').disabled = true;
                    taskWrapper.querySelector('.task').style.opacity = 0.6;
                    taskWrapper.querySelector('.task').style.textDecoration = 'line-through';
                }

                // Update food quantity after completing a task
                if (data.task_type === 'daily') {
                    alert('Congratulations for completing a daily task! You earned food!');
                    foodQuantity++;
                } else if (data.task_type === 'weekly') {
                    alert('Congratulations for completing a weekly task! You earned special food!');
                    specialfoodQuantity++;
                }
                updateFoodQuantity(); // Update the display after completing the task
                saveFoodQuantities(); // Persist the new quantity to the backend
            } else {
                alert('Failed to mark task as complete.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while marking the task as complete.');
        });
    }

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text");

        if (data === "logo") {
            alert(':(');
        }
        if (data === "foodIMG" || data === "specialfoodIMG") {
            // alert('Food given to pet!');
            if ((data === "foodIMG" && foodQuantity > 0)
                || (data === "specialfoodIMG" && specialfoodQuantity > 0)) {
                    feedPet(data === 'foodIMG' ? 'food' : 'special');
                }
        }
    }

    function showTaskPopup(taskType) {
        currentTaskType = taskType;
        document.getElementById('taskPopup').style.display = 'block';
        document.getElementById('taskOverlay').style.display = 'block';

        const repeatDaysInput = document.getElementById('repeatDaysInput');
        repeatDaysInput.style.display = taskType === 'daily' ? 'none' : 'block';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const petElement = document.getElementById('pet');
        const petArea = document.querySelector('.pet-display');
        const petType = "{{ pet_type }}";

        const petAnimations = {
            idle: `/static/Pet_Animations/${petType}/${petType}_Idle.gif`,
            pet: `/static/Pet_Animations/${petType}/${petType}_Pet.gif`,
            walkRight: `/static/Pet_Animations/${petType}/${petType}_Walk_Right.gif`,
            walkLeft: `/static/Pet_Animations/${petType}/${petType}_Walk_Left.gif`,
            treat: `/static/Pet_Animations/${petType}/${petType}_Treat.gif`
        };

        petElement.src = petAnimations.idle;
        let petPosition = { x: 100, y: 100 };
        let targetPosition = { x: 100, y: 100 };
        const speed = 0.3;
        let currentAnimation = 'idle';
        let isAnimating = false; // Prevent movement during animations

        function setPetAnimation(animation) {
            if (isAnimating) return; // prevent overlapping animations

            petElement.src = petAnimations[animation];
            isAnimating = true; // Stop movement

            setTimeout(() => {
                petElement.src = petAnimations.idle;
                isAnimating = false; // Resume movement

                // continue walking towards the target position
                const deltaX = targetPosition.x - petPosition.x;
                if (Math.abs(deltaX) > 0) {
                    if (deltaX > 0) {
                        petElement.src = petAnimations.walkRight;
                        currentAnimation = 'walkRight';
                    } else {
                        petElement.src = petAnimations.walkLeft;
                        currentAnimation = 'walkLeft';
                    }
                } else {
                    petElement.src = petAnimations.idle;
                    currentAnimation = 'idle';
                }

                updatePetPosition();
                }, 2000);

        }
        
        // Expose the animation function globally
        window.setPetAnimation = setPetAnimation;

        function updatePetPosition() {
            // skip if animation
            if (isAnimating) return;

            const deltaX = targetPosition.x - petPosition.x;
            const deltaY = targetPosition.y - petPosition.y;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

            if (distance < speed) {
                petPosition.x = targetPosition.x;
                petPosition.y = targetPosition.y;
                if (currentAnimation !== 'idle') {
                    petElement.src = petAnimations.idle;
                    currentAnimation = 'idle';
                }
            } else {
                petPosition.x += (deltaX / distance) * speed;
                petPosition.y += (deltaY / distance) * speed;

                if (deltaX >= 0 && currentAnimation !== 'walkRight') {
                    petElement.src = petAnimations.walkRight;
                    currentAnimation = 'walkRight';
                } else if (deltaX < 0 && currentAnimation !== 'walkLeft') {
                    petElement.src = petAnimations.walkLeft;
                    currentAnimation = 'walkLeft';
                }
            }

            petPosition.x = Math.max(0, Math.min(petPosition.x, petArea.offsetWidth - petElement.offsetWidth));
            petPosition.y = Math.max(0, Math.min(petPosition.y, petArea.offsetHeight - petElement.offsetHeight));
            petElement.style.transform = `translate(${petPosition.x}px, ${petPosition.y}px)`;

            requestAnimationFrame(updatePetPosition);
        }

        function movePetRandomly() {
            // skip if animation
            if (isAnimating) return;

            const maxX = petArea.clientWidth - petElement.clientWidth;
            const maxY = petArea.clientHeight - petElement.clientHeight - 20;

            targetPosition.x = Math.floor(Math.random() * maxX);
            targetPosition.y = Math.floor(Math.random() * maxY);
        }

        requestAnimationFrame(updatePetPosition);
        setInterval(movePetRandomly, 5000);

        petElement.addEventListener('click', () => {
            setPetAnimation('pet');
            // API call to update happiness
            fetch('/api/play_with_pet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('happiness').value = data.happiness;
                } else {
                    alert(data.message);
                }
            }).catch(console.error);
        });

        function updateFoodQuantity() {
            document.getElementById('foodQuantityDisplay').innerText = `Food Quantity: ${foodQuantity}`;
        }

        document.addEventListener('dragover', allowDrop);
        document.addEventListener('drop', drop);
    });

    function feedPet(foodType) {
            fetch('/api/feed_pet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `type=${foodType}`
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    foodQuantity = data.food_quantity;  
                    specialfoodQuantity = data.special_food_quantity;
                    updateFoodQuantity();
                    document.getElementById('hunger').value = data.hunger;

                    // Trigger the treat animation
                    setPetAnimation('treat');
                } else {
                    alert(data.message);
                }
            }).catch(console.error);
        }

    function updateFoodQuantity() {
        document.getElementById('foodQuantity').textContent = foodQuantity;
        document.getElementById('specialfoodQuantity').textContent = specialfoodQuantity;
    }

    function saveFoodQuantities() {
        fetch('/api/update_food_quantities', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `food_quantity=${foodQuantity}&special_food_quantity=${specialfoodQuantity}`
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Failed to update food quantities on server.');
            }
        })
        .catch(error => {
            console.error('Error updating food quantities:', error);
        });
    }

    function showCompletedTasks() {
        fetch('/api/completed_tasks')
            .then(response => response.json())
            .then(data => {
                if (data.tasks) {
                    // Clear previous tasks
                    const dailyTasksListElement = document.getElementById('dailyTasksList');
                    dailyTasksListElement.innerHTML = '';

                    // Populate lists with completed tasks
                    data.tasks.forEach(task => {
                        const taskElement = document.createElement('div');
                        taskElement.classList.add('completed-task-item');

                        const taskDescription = document.createElement('span');
                        taskDescription.textContent = task.description;

                        const completedDate = new Date(task.completed_at).toLocaleDateString();
                        const completedDateSpan = document.createElement('span');
                        completedDateSpan.classList.add('green-text');
                        if (task.is_deleted) {
                            completedDateSpan.textContent = ` (Deleted)`;
                            completedDateSpan.style.color = 'grey';
                        } else {
                            completedDateSpan.textContent = ` (Completed at: ${completedDate})`;
                        }

                        taskElement.appendChild(taskDescription);
                        taskElement.appendChild(completedDateSpan);

                        // Add the task to the completed tasks list
                        dailyTasksListElement.appendChild(taskElement);
                    });

                    // Show the popup
                    document.getElementById('completedTasksPopup').style.display = 'block';
                    document.getElementById('completedTasksOverlay').style.display = 'block';
                } else {
                    alert('No tasks found.');
                }
            })
            .catch(error => {
                console.error('Error fetching tasks:', error);
                alert('An error occurred while fetching tasks.');
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const petImage = document.getElementById('petImage');

        petImage.addEventListener('click', function() {
            petImage.src = 'path/to/_pet.gif';

            petImage.addEventListener('load', function() {
                setTimeout(function() {
                    petImage.src = 'path/to/static_pet_image.jpg';
                }, 3000);
            });
        });
    });

    window.onload = updateFoodQuantity;

</script>

</body>
</html>