<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KinetiQuest - Welcome</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        body {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(45deg, #ff9a9e, #fad0c4, #ff9a9e);
            background-size: 300% 300%;
            animation: gradientAnimation 10s ease infinite;
            overflow: hidden;
        }
        .container {
            text-align: center;
            font-size: 6em;
        }
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
    <style>
        .profile-button {
            position: fixed;
            top: 3%;
            right: 7%;
            background-color: #a37b5b;
            color: #fff;
            padding: 0.5em 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: Arial, sans-serif;
            font-size: 1.2em;
            z-index: 900;
        }
        .profile-button:hover {
            background-color: #a37b5b;
        }

        .logout-button {
            position: fixed;
            top: 3%;
            right: 1%;
            background-color: #a37b5b;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: Arial, sans-serif;
            font-size: 1.2em;
            z-index: 900;
        }

        .logout-button:hover {
            background-color: #a37b5b;
        }

        .completed-tasks-button {
            position: fixed;
            top: 3%;
            right: 13%;
            background-color: #a37b5b;
            color: #fff;
            padding: 0.5em 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: Arial, sans-serif;
            font-size: 1.2em;
            z-index: 900;
        }

        .completed-tasks-button:hover {
            background-color: #a37b5b;
        }

        .close-button {
            background-color: #d6bfa3;
            color: #fff;
            padding: 0.5em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
        }

        .close-button:hover {
            background-color: #0056b3;
        }

        .green-text {
            color: green;
        }
    </style>
    <style>
        .profile-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2em;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: none;
            z-index: 999;
        }
        .profile-popup h3 {
            margin: 0 0 15px;
            font-size: 1.5em;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }

        .logout-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2em;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: none;
            z-index: 1000;
        }
        .logout-popup h3 {
            margin: 0 0 15px;
            font-size: 1.5em;
        }

        .logout-popup button {
            background-color: #d6bfa3;
            color: #fff;
            padding: 0.5em 1em;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 0 10px;
        }
        .logout-popup button:hover {
            background-color: #0056b3;
        }
        .logout-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }

        .completed-tasks-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2em;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: none;
            z-index: 1000;
        }

        .completed-tasks-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 999;
        }

        .completed-tasks-popup h3 {
            margin: 0 0 15px;
            font-size: 1.5em;
        }

        .completed-task {
            text-decoration: line-through;
            opacity: 0.6;
        }

         .happiness-area {
            width: 29em;
            height: 9.5em;
            padding: 1em;
            background-color: #d6bfa3;
            border-radius: 10px;
            margin-top: 0.5em;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            align-self: flex-start;
            margin-left: -10em;
        }

        .happiness-bar, .hunger-bar {
            margin: 0.5em 0;
            font-size: 1em;
        }

        progress {
            width: 100%;
            height: 1.5em;
        }
    </style>
    <!-- Header and Top Margin Code -->
    <style>
        .line {
            position: fixed;
            top: 10.5%;
            left: 0;
            height: 6px;
            width: 100%;
            background-color: #000;
            z-index: 1;
        }

        .container img {
            position: fixed;
            top: 1%;
            left: 1%;
            width: 5%;
            height: auto;
            z-index: 900;
        }

        .content-wrapper {
            margin-top: 7em;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            gap: 4em;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: -5em;
        }

        .pet-area {
            background-color: #a37b5b;
            padding: 0.5em;
            border-radius: 1em;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            width: 30em;
            height: 30em;
            position: relative;
            margin-left: -10em;
        }

        .todo-lists {
            display: flex;
            flex-direction: column;
            width: 50%;
        }

        .todo-list, .weekly-todo-list {
            max-height: 300px;
            overflow-y: auto;
            background-color: #d6bfa3;
            padding: 2em;
            border-radius: 1em;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            width: 180%;
            position: relative;
            margin-top: 1em;
        }

        .scrollable-tasks {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            display: block;
            flex-wrap: wrap;
            height: 300px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1em;
        }

        .scrollable-tasks::-webkit-scrollbar {
            width: 12px;
        }

        .scrollable-tasks::-webkit-scrollbar-track {
            background: #f1e1c7;
            border-radius: 10px;
        }

        .scrollable-tasks::-webkit-scrollbar-thumb {
            background: #a37b5b;
            border-radius: 10px;
        }

        .scrollable-tasks::-webkit-scrollbar-thumb:hover {
            background: #8a634b;
        }

        .pet-display {
            background-color: #d6bfa3;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 30em;
            height: 30em;
            position: relative;
        }

        .food-area {
            width: 29em;
            padding: 1em;
            background-color: #d6bfa3;
            border-radius: 10px;
            display: flex;
            justify-content: space-evenly;
            align-items: flex-start;
            gap: 1em;
            margin-top: 1em;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            margin-left: -10em;
        }

        .food-item-container {
            display: flex;
            width: 35em;
            flex-direction: column;
            align-items: center;
        }

        .food-item {
            width: 20%;
            max-width: 4em;
            height: 4em;
            background-image: url('../static/food.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: grab;
            margin-bottom: -0.5em;
        }

        .food-label {
            margin-top: 0.5em;
            font-size: 0.9em;
            color: #333;
            text-align: center;
        }

        .food-drop-zone {
            width: 15%;
            max-width: 5em;
            height: 4em;
            border: 0.2em dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .todo-list h2, .weekly-todo-list h2 {
            text-align: center;
            font-size: 2.5em;
            margin-top: 0.5em;

        }

        .tasks {
            margin-top: 1em;
        }

        .task {
            display: flex;
            flex-grow: 1;
            align-items: center;
            max-width: calc(100% - 2em);
            overflow-wrap: break-word;
            word-break: break-word;
            text-overflow: ellipsis;
            overflow: hidden;
            padding: 0.5em;
            outline: none;
            border: none;
            background: none;
            cursor: text;
        }

        .styled-checkbox {
            appearance: none;
            width: 1.5em;
            height: 1.5em;
            border: 2px solid #4CAF50;
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            margin-right: 10px;
        }

        .styled-checkbox:checked {
            background-color: #4CAF50;
            border: none;
        }

        .styled-checkbox:checked::before {
            content: '✓';
            color: white;
            font-size: 1.2em;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .task:hover {
            background-color: #c9a98c;
        }

        .task .complete-checkbox {
            visibility: hidden;
            margin-right: 10px;
        }

        .task:hover .complete-checkbox {
            visibility: visible;
        }

        .task-content {
            flex-grow: 1;
        }

        .task:focus {
            max-height: 2em;
            overflow-y: auto;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        .task input[type="checkbox"] {
            margin-right: 1em;
        }

        .input-task {
            margin-top: 1em;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .input-task button {
            padding: 0.5em 1em;
            font-size: 1.2em;
            background-color: #a37b5b;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            transition: background-color 0.3s ease;
            z-index: 2;
        }

        .input-task button:hover {
            background-color: #0056b3;
        }

        .task-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2em;
            border-radius: 1em;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            display: none;
            z-index: 950;
        }

        .task-popup input[type="text"] {
            width: 80%;
            padding: 0.5em;
            font-size: 1.2em;
            border-radius: 5em;
            border: 0.1em solid #ccc;
            margin-bottom: 1em;
            box-sizing: border-box;
            z-index: 950;
        }

        .task-popup button {
            padding: 0.5em 1em;
            font-size: 1.2em;
            background-color: #d6bfa3;
            color: #fff;
            border: none;
            border-radius: 2em;
            cursor: pointer;
            margin: 0.5em;
            z-index: 950;
        }

        .task-popup button:hover {
            background-color: #0056b3;
        }

        .task-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 950;
        }

        .delete-button {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0.2em 0.6em;
            font-size: 1em;
            line-height: 1em;
            display: none;
            z-index: 1;
            transition: background-color 0.3s;
        }

        .task-wrapper {
            margin: 0;
            padding: 0em;
            box-sizing: border-box;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 8px;
        }

        .task-wrapper:hover .delete-btn {
            display: block;
        }

        .delete-btn {
            position: absolute;
            right: 10px;
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 0.2em 0.6em;
            font-size: 1em;
            display: none;
            transition: background-color 0.3s;
        }

        .delete-btn:hover {
            background-color: #c9302c;
        }

        .dimmed {
            filter: brightness(90%);
            pointer-events: none;
        }

    </style>
</head>
<body>
<!-- Header and Top Margin Code -->
<div class="header" style="text-align: center; width: 75%; position: fixed; top: 0px; z-index: 900;">
    <h1 style="font-family: 'VT323', monospace; font-size: 5em; margin: 10px 10px;">KinetiQuest</h1>
</div>
<div class="line"></div>
<div class="container">
    <img id="logo" src="../static/dogandcat.png" alt="Dog and Cat" draggable="true" ondragstart="drag(event)">
</div>

<!-- Completed Tasks -->
<button class="completed-tasks-button" onclick="showCompletedTasks()">Completed Tasks</button>
<button class="profile-button" onclick="showProfile()">Profile</button>
<button class="logout-button" onclick="showLogout()">Logout</button>

<!-- Main Content Area Wrapper -->
<div class="content-wrapper">
    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Pet Area -->
        <div class="pet-area" ondrop="drop(event)" ondragover="allowDrop(event)">
            <div class="pet-display">
                <h2>Pet Area</h2>
            </div>
        </div>

        <!-- Happiness Area -->
        <div class="happiness-area">
            <h2 style="text-align: center;">Pet Happiness & Hunger Levels</h2>
            <div class="happiness-bar">
                <label for="happiness">Happiness:</label>
                <progress id="happiness" value="{{ pet_happiness }}" max="100"></progress>
            </div>
            <div class="hunger-bar">
                <label for="hunger">Hunger:</label>
                <progress id="hunger" value="{{ pet_hunger }}" max="100"></progress>
            </div>
        </div>

        <!-- Food Area -->
        <div class="food-area">
            <div class="food-item-container">
                <div id="foodIMG" class="food-item" draggable="true" ondragstart="drag(event)" style="background-image: url('../static/food.png');"></div>
                <span class="food-label">Food Quantity: <span id="foodQuantity"></span></span>
            </div>
            <div class="food-item-container">
                <div id="specialfoodIMG" class="food-item" draggable="true" ondragstart="drag(event)" style="background-image: url('../static/specialfood.png');"></div>
                <span class="food-label">Special Food Quantity: <span id="specialfoodQuantity"></span></span>
            </div>
        </div>
    </div>

    <!-- To-do Lists Area -->
    <div class="todo-lists">
        <!-- Daily To-do List Area -->
        <div class="todo-list">
            <div class="input-task" style="position: absolute; top: 20px; right: 40px;">
                <button onclick="showTaskPopup('daily')">Add Task</button>
            </div>

            <h2 style="text-align: left; margin-bottom: 10px;">Daily Tasks</h2>
            <hr style="border: 1px solid #d6b588;">

            <!-- Scrollable task list -->
            <div class="scrollable-tasks" id="dailyTasks">
                {% for quest in user_quests %}
                {% if quest.quest_type == 'daily' %}
                <div class="task-wrapper">
                    <div class="task {% if quest.status == 'completed' %}completed-task{% endif %}" data-task-id="{{ quest.id }}">
                        <input type="checkbox" class="complete-checkbox styled-checkbox" onclick="markTaskComplete('{{ quest.id }}', 'daily')"
                               {% if quest.status == 'completed' %}checked disabled{% endif %}>
                        <span class="task-text" contenteditable="true">{{ quest.description }}</span>
                        <span class="task-due-date">{{ quest.due_date }}</span>
                        <span class="task-due-time">{{ quest.due_time }}</span>
                        <button class="delete-btn" onclick="deleteTask('{{ quest.id }}')">&times;</button>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Weekly To-do List Area -->
        <div class="weekly-todo-list">
            <div class="input-task" style="position: absolute; top: 20px; right: 40px;">
                <button onclick="showTaskPopup('weekly')">Add Task</button>
            </div>

            <h2 style="text-align: left; margin-bottom: 10px;">Weekly Tasks</h2>
            <hr style="border: 1px solid #d6b588;">

            <!-- Scrollable task list -->
            <div class="scrollable-tasks" id="weeklyTasks">
                {% for quest in user_quests %}
                {% if quest.quest_type == 'weekly' %}
                <div class="task-wrapper">
                    <div class="task" data-task-id="{{ quest.id }}">
                        <input type="checkbox" class="complete-checkbox styled-checkbox" onclick="markTaskComplete('{{ quest.id }}', 'weekly')">
                        <span class="task-text" contenteditable="true">{{ quest.description }}</span>
                        <span class="task-due-date">{{ quest.due_date }}</span>
                        <span class="task-due-time">{{ quest.due_time }}</span>
                        <span class="task-repeat-days">{{ quest.repeat_days }}</span>
                        <button class="delete-btn" onclick="deleteTask('{{ quest.id }}')">&times;</button>
                    </div>
                    <button class="delete-btn" onclick="deleteTask('{{ quest.id }}')">&times;</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Task Popup -->
<div class="task-overlay" id="taskOverlay"></div>
<div class="task-popup" id="taskPopup">
    <h3>Add New Task</h3>
    <input type="text" id="taskInput" placeholder="Enter a new task" maxlength="29">
    <input type="date" id="dueDateInput" placeholder="Due Date">
    <input type="time" id="dueTimeInput" placeholder="Due Time">
    <select id="repeatDaysInput" multiple>
        <option value="Monday">Monday</option>
        <option value="Tuesday">Tuesday</option>
        <option value="Wednesday">Wednesday</option>
        <option value="Thursday">Thursday</option>
        <option value="Friday">Friday</option>
        <option value="Saturday">Saturday</option>
        <option value="Sunday">Sunday</option>
    </select>
    <button onclick="addTask()">Add</button>
    <button onclick="closeTaskPopup()">Cancel</button>
</div>

<!-- Profile Popup -->
<div class="popup-overlay" id="popupOverlay"></div>
<div class="profile-popup" id="profilePopup">
    <h3>Profile</h3>
    <p>Username: {{ session['username'] }}</p>
    <button class="close-button" onclick="closeProfilePopup()">Close</button>
</div>

<!-- Logout Popup -->
<div class="logout-overlay" id="logoutOverlay"></div>
<div class="logout-popup" id="logoutPopup">
    <h3>Logout</h3>
    <p>Are you sure you want to logout?</p>
    <button onclick="logoutProfile()">Yes</button>
    <button onclick="closeLogoutPopup()">No</button>
</div>
<button class="logout-button" onclick="showLogout()">Logout</button>

<!-- Completed Tasks Popup -->
<div class="completed-tasks-overlay" id="completedTasksOverlay"></div>
<div class="completed-tasks-popup" id="completedTasksPopup">
    <h3>Completed Tasks</h3>
    <div id="dailyCompletedTasks">
        <h4>Daily Tasks</h4>
        <div id="dailyTasksList"></div>
    </div>
    <div id="weeklyCompletedTasks">
        <h4>Weekly Tasks</h4>
        <div id="weeklyTasksList"></div>
    </div>
    <button class="profile-popup-button" onclick="closeCompletedTasks()">Close</button>
</div>

<!-- JavaScript Code -->
<script>
    let currentTaskType = '';
    let foodQuantity = 1;
    let specialfoodQuantity = 1;

    function showProfile() {
        document.getElementById('profilePopup').style.display = 'block';
        document.getElementById('popupOverlay').style.display = 'block';
    }

    function closeProfilePopup() {
        document.getElementById('profilePopup').style.display = 'none';
        document.getElementById('popupOverlay').style.display = 'none';
    }

    function showLogout() {
        document.getElementById('logoutPopup').style.display = 'block';
        document.getElementById('popupOverlay').style.display = 'block';
    }

    function closeLogoutPopup() {
        document.getElementById('logoutPopup').style.display = 'none';
        document.getElementById('popupOverlay').style.display = 'none';
    }

    function logoutProfile() {
        document.getElementById('logoutPopup').style.display = 'none';
        document.getElementById('popupOverlay').style.display = 'none';
        window.location.href = '/';
    }

    function closeCompletedTasks() {
        document.getElementById('completedTasksPopup').style.display = 'none';
        document.getElementById('completedTasksOverlay').style.display = 'none';
    }

    function dimContent(dim) {
        const dimClass = 'dimmed';
        const elementsToDim = document.querySelectorAll('body > *:not(#popupOverlay):not(#profilePopup):not(#logoutPopup)');
        elementsToDim.forEach(element => {
            if (dim) {
                element.classList.add(dimClass);
            } else {
                element.classList.remove(dimClass);
            }
        });
    }

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
    }

    function drop(ev) {
        ev.preventDefault();
        const data = ev.dataTransfer.getData("text");

        if (data === "logo") {
            alert(':(');
            return;
        } else {
            if (data == "foodIMG") {
                if (foodQuantity == 0) {
                    alert('No food available!');
                    return;
                }
                alert('Food given to pet!');
                foodQuantity--;
                updateFoodQuantity();
                return;
            }
            else if (data == "specialfoodIMG") {
                if (specialfoodQuantity == 0) {
                    alert('No food available!');
                    return;
                }
                alert('Special food given to pet!');
                specialfoodQuantity--;
                updateFoodQuantity();
                return;
            }
            
            alert('That is not food!');
        }
    }

    function showTaskPopup(taskType) {
        currentTaskType = taskType;
        document.getElementById('taskPopup').style.display = 'block';
        document.getElementById('taskOverlay').style.display = 'block';

        const repeatDaysInput = document.getElementById('repeatDaysInput');
        repeatDaysInput.style.display = taskType === 'daily' ? 'none' : 'block';
    }

    function closeTaskPopup() {
        document.getElementById('taskPopup').style.display = 'none';
        document.getElementById('taskOverlay').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const taskInput = document.getElementById('taskInput');

        taskInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addTask();
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.task-text').forEach(taskElement => {
            taskElement.addEventListener('focus', function() {
                this.dataset.originalValue = this.innerText;
            });
            taskElement.addEventListener('blur', function() {
                const taskId = this.closest('.task').dataset.taskId;
                const newDescription = this.innerText;
                updateTask(taskId, newDescription);
            });
            taskElement.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    this.innerText = this.dataset.originalValue;
                    this.blur();
                } else if (event.key === 'Enter') {
                    event.preventDefault();
                    this.blur();
                }
            });
            taskElement.addEventListener('input', function() {
                if (this.innerText.length > 29) {
                    this.innerText = this.innerText.substring(0, 29);
                    const range = document.createRange();
                    const selection = window.getSelection();
                    range.selectNodeContents(this);
                    range.collapse(false);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            });
        });
    });

    function addTask() {
        const taskInputElement = document.getElementById('taskInput');
        const taskInput = taskInputElement.value;
        const dueDate = document.getElementById('dueDateInput').value;
        const dueTime = document.getElementById('dueTimeInput').value;
        const repeatDays = Array.from(document.getElementById('repeatDaysInput').selectedOptions)
                            .map(option => option.value);

        if (taskInput.length > 29) {
            alert("Task description cannot exceed 29 characters.");
            return;
        }
        const taskType = currentTaskType;

        if (!taskInput.trim()) {
            alert("Task description cannot be empty.");
            return;
        }

        fetch('/api/add_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `task_description=${encodeURIComponent(taskInput)}&task_type=${encodeURIComponent(taskType)}&due_date=${encodeURIComponent(dueDate)}&due_time=${encodeURIComponent(dueTime)}&repeat_days=${encodeURIComponent(repeatDays)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const taskList = document.getElementById(taskType === 'daily' ? 'dailyTasks' : 'weeklyTasks');
                const newTaskWrapper = document.createElement('div');
                newTaskWrapper.classList.add('task-wrapper');

                // Create task container
                const taskContainer = document.createElement('div');
                taskContainer.classList.add('task');
                taskContainer.dataset.taskId = data.task_id;

                // Create checkbox element for marking task complete
                const completeCheckbox = document.createElement('input');
                completeCheckbox.type = 'checkbox';
                completeCheckbox.classList.add('complete-checkbox', 'styled-checkbox');
                completeCheckbox.onclick = () => markTaskComplete(data.task_id, taskType);
                taskContainer.appendChild(completeCheckbox);

                // Add a span for the task description
                const taskText = document.createElement('span');
                taskText.classList.add('task-text');
                taskText.contentEditable = 'true';
                taskText.textContent = taskInput;
                taskContainer.appendChild(taskText);

                // Add event listeners for editing and focusing the task description
                taskText.addEventListener('focus', function() {
                    this.dataset.originalValue = this.innerText;
                });
                taskText.addEventListener('blur', function() {
                    const taskId = this.closest('.task').dataset.taskId;
                    const newDescription = this.innerText;
                    updateTask(taskId, newDescription);
                });
                taskText.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        this.innerText = this.dataset.originalValue;
                        this.blur();
                    } else if (event.key === 'Enter') {
                        event.preventDefault();
                        this.blur();
                    }
                });

                // Delete button
                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-btn');
                deleteButton.innerHTML = '&times;';
                deleteButton.onclick = () => deleteTask(data.task_id);
                newTaskWrapper.appendChild(taskContainer);
                newTaskWrapper.appendChild(deleteButton);

                // Append new task wrapper to the task list
                taskList.appendChild(newTaskWrapper);

                // Clear input field after adding the task
                taskInputElement.value = '';
            } else {
                alert('Failed to add task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error occurred while making the request:', error);
            alert('An error occurred while adding the task.');
        });
        closeTaskPopup();
    }

    function updateTask(taskId, newDescription) {
        if (!newDescription.trim()) {
            alert("Task description cannot be empty.");
            return;
        }
        fetch('/api/update_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `task_id=${encodeURIComponent(taskId)}&new_description=${encodeURIComponent(newDescription)}&new_due_date=${encodeURIComponent(newDueDate)}&new_repeat_days=${encodeURIComponent(newRepeatDays)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Task updated successfully.');
            } else {
                alert('Failed to update task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the task.');
        });
    }

    function adjustScrollableHeight() {
        const scrollableTasks = document.querySelector('.scrollable-tasks');
        const taskCount = scrollableTasks.children.length;

        if (taskCount === 0) {
            scrollableTasks.style.height = 'auto';
        } else {
            scrollableTasks.style.height = '';
        }
    }

    function deleteTask(taskId) {
        fetch('/api/delete_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `task_id=${encodeURIComponent(taskId)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const taskElement = document.querySelector(`.task[data-task-id='${taskId}']`);
                if (taskElement) {
                    taskElement.closest('.task-wrapper').remove();
                    adjustScrollableHeight();
                }
            } else {
                alert('Failed to delete task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the task.');
        });
    }

    function markTaskComplete(taskId, taskType) {
        if (!taskId) {
            alert('Invalid task ID.');
            return;
        }

        fetch('/api/complete_task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `task_id=${encodeURIComponent(taskId)}`
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Unknown error occurred');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('Task marked as completed.');

                if (taskType === 'daily') {
                    alert('Congratulations for completing a daily task! You earned food!');
                    foodQuantity++;
                }
                else if (taskType === 'weekly') {
                    alert('Congratulations for completing a weekly task! You earned special food!');
                    specialfoodQuantity++;
                }
                updateFoodQuantity();

                const taskElement = document.querySelector(`.task[data-task-id='${taskId}']`);
                if (taskElement) {
                    taskElement.classList.add('completed-task');
                }
            } else if (data.error) {
                alert('Failed to complete task: ' + data.error);
            } else {
                alert('Unexpected response format.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while marking the task as completed: ' + error.message);
        });
    }

    function showCompletedTasks() {
        fetch('/api/completed_tasks')
            .then(response => response.json())
            .then(data => {
                if (data.tasks) {
                    // Clear previous tasks
                    const dailyTasksListElement = document.getElementById('dailyTasksList');
                    const weeklyTasksListElement = document.getElementById('weeklyTasksList');
                    dailyTasksListElement.innerHTML = '';
                    weeklyTasksListElement.innerHTML = '';

                    // Populate lists with completed tasks
                    data.tasks.forEach(task => {
                        const taskElement = document.createElement('div');
                        taskElement.classList.add('completed-task-item');

                        const taskDescription = document.createElement('span');
                        taskDescription.textContent = task.description;

                        const completedDate = new Date(task.completed_at).toLocaleDateString();
                        const completedDateSpan = document.createElement('span');
                        completedDateSpan.classList.add('green-text');
                        if (task.is_deleted) {
                            completedDateSpan.textContent = ` (Deleted)`;
                            completedDateSpan.style.color = 'grey';
                        } else {
                            completedDateSpan.textContent = ` (Completed at: ${completedDate})`;
                        }

                        taskElement.appendChild(taskDescription);
                        taskElement.appendChild(completedDateSpan);

                        // Add the task to either daily or weekly tasks list
                        if (task.quest_type === 'daily') {
                            dailyTasksListElement.appendChild(taskElement);
                        } else if (task.quest_type === 'weekly') {
                            weeklyTasksListElement.appendChild(taskElement);
                        }
                    });

                    // Show the popup
                    document.getElementById('completedTasksPopup').style.display = 'block';
                    document.getElementById('completedTasksOverlay').style.display = 'block';
                } else {
                    alert('No tasks found.');
                }
            })
            .catch(error => {
                console.error('Error fetching tasks:', error);
                alert('An error occurred while fetching tasks.');
            });
    }

    function updateFoodQuantity() {
        document.getElementById('foodQuantity').textContent = foodQuantity;
        document.getElementById('specialfoodQuantity').textContent = specialfoodQuantity;
    }

    window.onload = updateFoodQuantity;

</script>

</body>
</html>